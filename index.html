<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/logo192.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="description" content="Sistema de Punto de Venta (POS)" />
  <title>MiNegocio POS</title>
  <link rel="manifest" href="/manifest.json" />
</head>

<body>
  <div id="root"></div>

  <script>
    // 1. DETECTOR DE ERRORES DE CARGA (Cuando Vercel borra archivos viejos)
    window.addEventListener('error', function (e) {
      // Filtramos errores típicos de cuando una versión deja de existir
      if (e.message && (
        e.message.includes('Loading chunk') ||
        e.message.includes('import') ||
        e.message.includes('not found') ||
        e.message.includes('Unexpected token') ||
        e.message.includes('Failed to fetch')
      )) {
        console.error('⚠️ Error crítico de versión detectado. Iniciando limpieza de emergencia...');
        nukeCacheAndReload();
      }
    }, true);

    // 2. FUNCIÓN NUCLEAR: Borra Service Worker y Caché
    async function nukeCacheAndReload() {
      try {
        // A. Desregistrar Service Worker
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (let registration of registrations) {
            await registration.unregister();
          }
        }

        // B. Borrar Almacenamiento Caché
        if ('caches' in window) {
          const keys = await caches.keys();
          for (let key of keys) {
            await caches.delete(key);
          }
        }
      } catch (err) {
        console.error("Error al limpiar caché:", err);
      } finally {
        // C. Recarga forzada desde el servidor
        window.location.reload(true);
      }
    }

    // 3. CENTINELA DE TIEMPO (Pantalla Blanca)
    // Si React no ha logrado poner nada en el div "root" después de 4 segundos...
    setTimeout(() => {
      const root = document.getElementById('root');
      // Verificamos si está vacío
      if (root && root.innerHTML.trim() === '') {
        console.warn('⚠️ La app tardó demasiado en arrancar. Posible error de caché.');

        // Evitamos que esto pase en tu computadora mientras programas (localhost)
        if (!window.location.hostname.includes('localhost')) {
          nukeCacheAndReload();
        }
      }
    }, 4000); // 4 segundos de tolerancia
  </script>
  <script type="module" src="/src/main.jsx"></script>
</body>

</html>