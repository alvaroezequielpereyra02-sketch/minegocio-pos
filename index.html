<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/logo192.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#2563eb" />
  <title>MiNegocio POS</title>
  <link rel="manifest" href="/manifest.json" />
</head>

<body>
  <div id="root"></div>

  <script>
    // 1. Detector de Errores de Carga (Chunk Load Error / 404)
    window.addEventListener('error', function (e) {
      // Si el error es sobre archivos JS que faltan (lo que causa el 404)
      if (e.message && (
        e.message.includes('Loading chunk') ||
        e.message.includes('import') ||
        e.message.includes('not found') ||
        e.message.includes('Unexpected token')
      )) {
        console.error('⚠️ Error de versión detectado. Limpiando caché...');
        nukeCacheAndReload();
      }
    }, true);

    // 2. Función Nuclear: Borra todo el caché y el Service Worker
    async function nukeCacheAndReload() {
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (let registration of registrations) {
          await registration.unregister(); // Desregistra el SW viejo
        }
      }

      if ('caches' in window) {
        const keys = await caches.keys();
        for (let key of keys) {
          await caches.delete(key); // Borra todos los archivos viejos
        }
      }

      // Forzar recarga desde el servidor (no desde caché)
      window.location.reload(true);
    }

    // 3. Verificación de "Resurección"
    // Si la app tarda más de 3 segundos en iniciar React (root vacío), asume que se rompió y recarga.
    setTimeout(() => {
      const root = document.getElementById('root');
      if (root && root.innerHTML.trim() === '') {
        console.warn('⚠️ La app no arrancó en 3s. Intentando recuperación...');
        // Solo hacemos esto si no estamos en localhost para no molestar el desarrollo
        if (!window.location.hostname.includes('localhost')) {
          nukeCacheAndReload();
        }
      }
    }, 4000);
  </script>
  <script type="module" src="/src/main.jsx"></script>
</body>

</html>